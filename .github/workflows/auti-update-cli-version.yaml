name: Auto Update Bitwarden CLI Version

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # Needed for the create-pull-request action to commit changes
        with:
          token: ${{ secrets.PAT_FOR_PR }}

      - name: Find latest Bitwarden CLI version
        id: get_latest
        run: |
          # Query Bitwarden clients releases, filter by name containing 'CLI', and get the tag name
          LATEST_RELEASE_TAG=$(curl -s "https://api.github.com/repos/bitwarden/clients/releases" | \
            jq -r '.[] | select(.name | test("CLI")) | .tag_name' | \
            head -n 1)
          
          # Extract the version number (e.g., 'cli-v2025.9.0' -> '2025.9.0')
          LATEST_VERSION=$(echo "$LATEST_RELEASE_TAG" | sed 's/cli-v//')
          
          echo "Found latest version: $LATEST_VERSION (from tag: $LATEST_RELEASE_TAG)"
          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT

      - name: Get current version from Dockerfile
        id: get_current
        run: |
          # Extract the version from the Dockerfile's ARG line
          CURRENT_VERSION=$(grep 'BW_CLI_VERSION=' Dockerfile | head -n 1 | cut -d'=' -f2)
          echo "Current version in Dockerfile: $CURRENT_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Check if update is needed
        id: check_update
        if: steps.get_latest.outputs.latest_version != steps.get_current.outputs.current_version
        run: |
          echo "New version available: ${{ steps.get_latest.outputs.latest_version }}"
          
          # Use sed to replace the version in the Dockerfile
          # This assumes the ARG line is "ARG BW_CLI_VERSION=..."
          sed -i "s/ARG BW_CLI_VERSION=.*/ARG BW_CLI_VERSION=${{ steps.get_latest.outputs.latest_version }}/" Dockerfile
          
          # Set flag to create PR
          echo "create_pr=true" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.check_update.outputs.create_pr == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_FOR_PR }}
          commit-message: 'feat(deps): Update Bitwarden CLI to v${{ steps.get_latest.outputs.latest_version }}'
          title: 'Update Bitwarden CLI to v${{ steps.get_latest.outputs.latest_version }}'
          body: |
            Bumps the Bitwarden CLI version in `Dockerfile` to **v${{ steps.get_latest.outputs.latest_version }}**.
            
            This was automatically generated by the scheduled workflow.
          branch: 'chore/update-bw-cli-v${{ steps.get_latest.outputs.latest_version }}'
          delete-branch: true
